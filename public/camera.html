<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Caméra Babycam</title>
    <style>
        body { 
            text-align: center; 
            background-color: #f0f0f0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
        }
        h1 {
            color: #333;
        }
        video { 
            width: 90%; 
            max-width: 400px; 
            border: 4px solid #f44336; 
            border-radius: 10px;
            margin-top: 20px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        button { 
            padding: 10px 20px; 
            font-size: 16px; 
            margin-top: 20px; 
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
        }
        button:disabled {
            background-color: #9E9E9E;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #45a049;
        }
        #logs {
            width: 90%;
            max-width: 400px;
            height: 200px;
            border: 2px solid #ccc;
            background-color: #fff;
            margin: 20px auto;
            padding: 10px;
            overflow-y: scroll;
            text-align: left;
            font-size: 14px;
            white-space: pre-wrap;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .alert {
            padding: 10px;
            background-color: #f44336;
            color: white;
            margin-top: 20px;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Caméra Babycam</h1>
    <video id="video" autoplay muted></video>
    <br>
    <button id="start">Démarrer la diffusion</button>
    <div id="logs"></div>
    <div id="alerts" class="alert"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        const video = document.getElementById('video');
        const startButton = document.getElementById('start');
        const logs = document.getElementById('logs');
        const alerts = document.getElementById('alerts');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logs.textContent += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        function showAlert(message) {
            alerts.textContent = message;
            alerts.style.display = 'block';
            setTimeout(() => {
                alerts.style.display = 'none';
            }, 5000); // Masquer après 5 secondes
        }

        let mediaRecorder;
        let motionDetector;
        let noiseDetector;

        startButton.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                video.srcObject = stream;
                log('Accès à la caméra et au microphone autorisé.');

                // Initialiser le MediaRecorder
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp8' });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        event.data.arrayBuffer().then(buffer => {
                            socket.emit('video-stream', buffer);
                            log('Données vidéo envoyées au serveur.');
                        }).catch(e => {
                            log('Erreur lors de la conversion des données vidéo: ' + e);
                        });
                    }
                };

                mediaRecorder.start(100); // Envoie des données toutes les 100ms
                log('MediaRecorder démarré.');
                startButton.disabled = true;

                // Initialiser les détecteurs
                initializeMotionDetector(stream);
                initializeNoiseDetector(stream);
            } catch (e) {
                log('Erreur lors de l\'accès à la caméra/microphone: ' + e);
            }
        };

        socket.on('connect', () => {
            log('Connecté au serveur.');
        });

        socket.on('disconnect', () => {
            log('Déconnecté du serveur.');
        });

        socket.on('error', (error) => {
            log('Erreur Socket.io: ' + error);
        });

        // Détecteur de Mouvement
        function initializeMotionDetector(stream) {
            const videoElement = document.createElement('video');
            videoElement.srcObject = stream;
            videoElement.play();

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            let previousFrame = null;
            const motionThreshold = 30; // Ajustez ce seuil selon vos besoins

            videoElement.addEventListener('play', () => {
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
                detectMotion();
            });

            function detectMotion() {
                if (videoElement.paused || videoElement.ended) {
                    return;
                }

                context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                const currentFrame = context.getImageData(0, 0, canvas.width, canvas.height);

                if (previousFrame) {
                    let motionPixels = 0;
                    for (let i = 0; i < currentFrame.data.length; i += 4) {
                        const rDiff = Math.abs(currentFrame.data[i] - previousFrame.data[i]);
                        const gDiff = Math.abs(currentFrame.data[i + 1] - previousFrame.data[i + 1]);
                        const bDiff = Math.abs(currentFrame.data[i + 2] - previousFrame.data[i + 2]);

                        const totalDiff = rDiff + gDiff + bDiff;
                        if (totalDiff > motionThreshold) {
                            motionPixels++;
                        }
                    }

                    const motionPercentage = (motionPixels / (currentFrame.data.length / 4)) * 100;
                    if (motionPercentage > 1) { // Seuil de détection de mouvement (1%)
                        log('Mouvement détecté.');
                        showAlert('Mouvement détecté!');
                    }
                }

                previousFrame = currentFrame;
                requestAnimationFrame(detectMotion);
            }
        }

        // Détecteur de Bruit
        function initializeNoiseDetector(stream) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const microphone = audioContext.createMediaStreamSource(stream);
            const scriptProcessor = audioContext.createScriptProcessor(2048, 1, 1);

            analyser.smoothingTimeConstant = 0.8;
            analyser.fftSize = 1024;

            microphone.connect(analyser);
            analyser.connect(scriptProcessor);
            scriptProcessor.connect(audioContext.destination);

            const noiseThreshold = 0.02; // Ajustez ce seuil selon vos besoins

            scriptProcessor.onaudioprocess = () => {
                const array = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(array);
                let values = 0;

                for (let i = 0; i < array.length; i++) {
                    values += array[i];
                }

                const average = values / array.length / 256; // Normaliser entre 0 et 1

                if (average > noiseThreshold) {
                    log('Bruit détecté.');
                    showAlert('Bruit détecté!');
                }
            };
        }
    </script>
</body>
</html>
